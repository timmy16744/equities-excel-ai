<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Chiara + Tim | 4/4</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://unpkg.com/@studio-freight/lenis@1.0.34/dist/lenis.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

  <style>
    :root {
      --text: #ffffff; 
      --text-muted: rgba(255, 255, 255, 0.7);
      --bg: #06070e;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* Hide custom cursor native styling on desktop, but allow native on mobile */
    @media (pointer: fine) {
      * { cursor: none !important; }
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      overflow-x: hidden;
      width: 100vw;
      max-width: 100%;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Fixed WebGL Background */
    #webGLApp {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 0;
      pointer-events: none; 
    }

    /* Vignette Scrim */
    .vignette {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: radial-gradient(circle at center, rgba(6, 7, 14, 0.1) 0%, rgba(6, 7, 14, 0.7) 100%);
      z-index: 1;
      pointer-events: none;
    }

    /* Custom Cursor (Hidden on Touch Devices) */
    .custom-cursor {
      position: fixed;
      width: 40px;
      height: 40px;
      border: 2px solid var(--text-muted);
      border-radius: 50%;
      pointer-events: none;
      z-index: 9999;
      transform: translate(-50%, -50%);
      transition: width 0.2s ease, height 0.2s ease, border-color 0.2s ease, background 0.2s ease;
      background: transparent;
      will-change: transform;
    }
    .custom-cursor::before {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 6px;
      height: 6px;
      background: var(--text);
      border-radius: 50%;
    }

    @media (pointer: coarse), (max-width: 768px) {
      .custom-cursor { display: none !important; }
    }

    /* Content Wrapper */
    main {
      position: relative;
      z-index: 10;
      width: 100%;
    }

    /* Typography Defaults */
    h1, h2, h3, .syne {
      font-family: 'Syne', sans-serif;
      text-shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
    }

    .heading-huge {
      font-size: clamp(3rem, 13vw, 11rem);
      font-weight: 800;
      line-height: 0.9;
      letter-spacing: -0.03em;
      text-transform: uppercase;
    }

    /* Frosted Glass Base */
    .glass-card {
      background: rgba(15, 16, 26, 0.25);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 24px;
      padding: 3rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    /* Hero Section */
    .hero {
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 2.5rem;
    }

    nav {
      display: flex;
      justify-content: space-between;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .hero-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .line-wrapper {
      overflow: hidden;
      padding-bottom: 0.1em;
    }

    .hero-meta {
      display: flex;
      gap: 3rem;
      margin-top: 3rem;
      font-weight: 600;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      text-shadow: 0 2px 10px rgba(0,0,0,0.5);
    }

    .rsvp-btn {
      margin-top: 2rem;
      padding: 0.85rem 1.4rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.35);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 0.82rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      transition: background 0.2s ease, border-color 0.2s ease, transform 0.2s ease;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .rsvp-btn:hover {
      background: rgba(255, 255, 255, 0.14);
      border-color: rgba(255, 255, 255, 0.55);
      transform: translateY(-1px);
    }

    .rsvp-modal {
      position: fixed;
      inset: 0;
      z-index: 1200;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .rsvp-modal.open {
      display: flex;
    }
    .rsvp-modal__backdrop {
      position: absolute;
      inset: 0;
      background: rgba(5, 8, 14, 0.72);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .rsvp-modal__panel {
      position: relative;
      z-index: 1;
      width: min(560px, 94vw);
      padding: 1.4rem;
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(12, 15, 25, 0.7);
      box-shadow: 0 24px 44px rgba(0, 0, 0, 0.4);
    }
    .rsvp-modal__top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.9rem;
      gap: 1rem;
    }
    .rsvp-modal__top h3 {
      font-size: 1.3rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }
    .rsvp-close {
      border: 1px solid rgba(255, 255, 255, 0.25);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 999px;
      width: 34px;
      height: 34px;
      font-size: 1rem;
      line-height: 1;
    }
    .rsvp-form {
      display: grid;
      gap: 0.7rem;
    }
    .rsvp-form label {
      display: grid;
      gap: 0.4rem;
      font-size: 0.8rem;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
    }
    .rsvp-form input,
    .rsvp-form textarea {
      width: 100%;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 0.8rem 0.9rem;
      font: inherit;
      outline: none;
    }
    .rsvp-form input:focus,
    .rsvp-form textarea:focus {
      border-color: rgba(255, 255, 255, 0.55);
    }
    .rsvp-form textarea {
      min-height: 92px;
      resize: vertical;
    }
    .rsvp-submit {
      margin-top: 0.35rem;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.36);
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 0.78rem 1.1rem;
    }

    /* Details Section */
    .details-section {
      padding: 10rem 2rem;
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .details-section .container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      gap: 4rem;
      width: 100%;
    }

    .col {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .col .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 2rem;
      color: var(--text-muted);
      border-bottom: 1px solid rgba(255, 255, 255, 0.15);
      padding-bottom: 1rem;
      font-weight: 600;
    }

    .col h2 {
      font-size: clamp(2.2rem, 5vw, 4rem);
      font-weight: 700;
      line-height: 1.1;
      letter-spacing: -0.02em;
      margin-bottom: 1rem;
    }

    .col .time {
      font-size: 1.125rem;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* Dress Code */
    .dress-code-section {
      min-height: 80vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 4rem 2rem;
      text-align: center;
    }

    .dress-code-content {
      max-width: 900px;
      width: 100%;
    }

    .dress-code-content .label {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      margin-bottom: 2rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .dress-code-content h2 {
      font-size: clamp(2.2rem, 6vw, 5rem);
      font-weight: 700;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }

    /* Footer */
    .footer {
      padding: 8rem 2rem 4rem;
      text-align: center;
    }

    .footer h1 {
      font-size: clamp(4.5rem, 18vw, 15rem);
      line-height: 1;
      margin-top: 1.5rem;
    }

    .countdown-minimal {
      margin-top: 1rem;
      font-size: 0.85rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 600;
    }

    /* Mobile Optimizations */
    @media (max-width: 768px) {
      .hero {
        padding: 1.5rem;
      }
      .hero-meta {
        flex-direction: column;
        gap: 0.75rem;
        margin-top: 2rem;
      }
      .rsvp-btn {
        margin-top: 1.4rem;
      }
      .details-section {
        padding: 5rem 1.5rem;
      }
      .details-section .container {
        gap: 2rem;
      }
      .glass-card {
        padding: 2.5rem 1.5rem;
        text-align: center;
      }
      .col {
        align-items: center;
      }
      .col .time {
        font-size: 1rem;
      }
      .dress-code-section {
        padding: 2rem 1.5rem;
        min-height: 60vh;
      }
      .footer {
        padding: 4rem 1.5rem 3rem;
      }
    }
  </style>
</head>
<body>

  <!-- Custom Cursor -->
  <div class="custom-cursor" id="customCursor"></div>

  <!-- WebGL Liquid Gradient Background -->
  <div id="webGLApp"></div>
  
  <!-- Optical Vignette to anchor text -->
  <div class="vignette"></div>

  <!-- Scrollable Content -->
  <main>
    <!-- Hero -->
    <section class="hero">
      <nav class="nav-fade">
        <span>Chiara & Tim</span>
        <span>04 . 04</span>
      </nav>
      <div class="hero-content">
        <h1 class="heading-huge">
          <div class="line-wrapper"><div class="line">Chiara</div></div>
          <div class="line-wrapper"><div class="line">+ Tim</div></div>
        </h1>
        <div class="hero-meta nav-fade">
          <p>Adelaide Botanic Gardens</p>
          <p>4:30 PM (Arrive 4:15)</p>
        </div>
        <button type="button" class="rsvp-btn nav-fade" id="openRsvpBtn">RSVP</button>
      </div>
    </section>

    <!-- Details -->
    <section class="details-section">
      <div class="container">
        <div class="col glass-card gs-reveal">
          <p class="label">01. Ceremony</p>
          <h2>Adelaide Botanic <br>Gardens</h2>
          <p class="time">Economic Garden<br>At 4:30 in the afternoon.<br>(please arrive by 4:15)</p>
        </div>
        <div class="col glass-card gs-reveal">
          <p class="label">02. Reception</p>
          <h2>Paper Tiger</h2>
          <p class="time">Dinner, drinks & celebrations<br>to follow the ceremony.</p>
        </div>
      </div>
    </section>

    <!-- Dress Code -->
    <section class="dress-code-section">
      <div class="dress-code-content glass-card gs-reveal-up">
        <p class="label">Dress Code</p>
        <h2>Semi formal garden party</h2>
      </div>
    </section>

    <!-- Footer -->
    <footer class="footer gs-reveal">
      <p class="syne" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); font-size: clamp(0.75rem, 3vw, 1rem);">Can't wait to celebrate with you</p>
      <h1 class="heading-huge">04 / 04</h1>
      <p class="countdown-minimal" id="countdownMinimal">Loading countdown...</p>
    </footer>
  </main>

  <div class="rsvp-modal" id="rsvpModal" aria-hidden="true">
    <div class="rsvp-modal__backdrop" id="rsvpBackdrop"></div>
    <div class="rsvp-modal__panel glass-card" role="dialog" aria-modal="true" aria-labelledby="rsvpTitle">
      <div class="rsvp-modal__top">
        <h3 id="rsvpTitle">RSVP</h3>
        <button type="button" class="rsvp-close" id="closeRsvpBtn" aria-label="Close RSVP form">X</button>
      </div>
      <form class="rsvp-form" action="https://formsubmit.co/chiaramarinoo@gmail.com" method="POST">
        <input type="hidden" name="_subject" value="Wedding RSVP - Chiara + Tim">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_template" value="table">
        <label>
          Name
          <input type="text" name="Name" required>
        </label>
        <label>
          Guest(s) Name
          <input type="text" name="Guests Name">
        </label>
        <label>
          Dietary
          <textarea name="Dietary"></textarea>
        </label>
        <button type="submit" class="rsvp-submit">Send RSVP</button>
      </form>
    </div>
  </div>

  <script>
    // ==========================================
    // 1. THREE.JS LIQUID GRADIENT BACKGROUND
    // ==========================================
    class TouchTexture {
      constructor() {
        this.size = 64;
        this.width = this.height = this.size;
        this.maxAge = 64;
        this.radius = 0.25 * this.size; 
        this.speed = 1 / this.maxAge;
        this.trail = [];
        this.last = null;
        this.initTexture();
      }

      initTexture() {
        this.canvas = document.createElement("canvas");
        this.canvas.width = this.width;
        this.canvas.height = this.height;
        this.ctx = this.canvas.getContext("2d");
        this.ctx.fillStyle = "black";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        this.texture = new THREE.Texture(this.canvas);
      }

      update() {
        this.clear();
        let speed = this.speed;
        for (let i = this.trail.length - 1; i >= 0; i--) {
          const point = this.trail[i];
          let f = point.force * speed * (1 - point.age / this.maxAge);
          point.x += point.vx * f;
          point.y += point.vy * f;
          point.age++;
          if (point.age > this.maxAge) {
            this.trail.splice(i, 1);
          } else {
            this.drawPoint(point);
          }
        }
        this.texture.needsUpdate = true;
      }

      clear() {
        this.ctx.fillStyle = "black";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
      }

      addTouch(point) {
        let force = 0;
        let vx = 0;
        let vy = 0;
        const last = this.last;
        if (last) {
          const dx = point.x - last.x;
          const dy = point.y - last.y;
          if (dx === 0 && dy === 0) return;
          const dd = dx * dx + dy * dy;
          let d = Math.sqrt(dd);
          vx = dx / d;
          vy = dy / d;
          force = Math.min(dd * 20000, 2.0);
        }
        this.last = { x: point.x, y: point.y };
        this.trail.push({ x: point.x, y: point.y, age: 0, force, vx, vy });
      }

      drawPoint(point) {
        const pos = {
          x: point.x * this.width,
          y: (1 - point.y) * this.height
        };

        let intensity = 1;
        if (point.age < this.maxAge * 0.3) {
          intensity = Math.sin((point.age / (this.maxAge * 0.3)) * (Math.PI / 2));
        } else {
          const t = 1 - (point.age - this.maxAge * 0.3) / (this.maxAge * 0.7);
          intensity = -t * (t - 2);
        }
        intensity *= point.force;

        const radius = this.radius;
        let color = `${((point.vx + 1) / 2) * 255}, ${((point.vy + 1) / 2) * 255}, ${intensity * 255}`;
        let offset = this.size * 5;
        this.ctx.shadowOffsetX = offset;
        this.ctx.shadowOffsetY = offset;
        this.ctx.shadowBlur = radius * 1;
        this.ctx.shadowColor = `rgba(${color},${0.2 * intensity})`;

        this.ctx.beginPath();
        this.ctx.fillStyle = "rgba(255,0,0,1)";
        this.ctx.arc(pos.x - offset, pos.y - offset, radius, 0, Math.PI * 2);
        this.ctx.fill();
      }
    }

    class GradientBackground {
      constructor(sceneManager) {
        this.sceneManager = sceneManager;
        this.mesh = null;
        
        // Deep Purple & Blue Color Palette configuration
        this.uniforms = {
          uTime: { value: 0 },
          uResolution: { value: new THREE.Vector2(window.innerWidth, window.innerHeight) },
          
          uColor1: { value: new THREE.Vector3(0.42, 0.13, 0.66) }, // Rich Purple
          uColor2: { value: new THREE.Vector3(0.12, 0.23, 0.54) }, // Deep Royal Blue
          uColor3: { value: new THREE.Vector3(0.58, 0.20, 0.92) }, // Bright Violet
          uColor4: { value: new THREE.Vector3(0.15, 0.39, 0.92) }, // Ocean Blue
          uColor5: { value: new THREE.Vector3(0.26, 0.22, 0.79) }, // Indigo
          uColor6: { value: new THREE.Vector3(0.49, 0.23, 0.93) }, // Soft Violet
          
          uSpeed: { value: 0.8 }, 
          uIntensity: { value: 1.4 },
          uTouchTexture: { value: null },
          uGrainIntensity: { value: 0.05 }, 
          uDarkNavy: { value: new THREE.Vector3(0.06, 0.09, 0.16) }, // Very dark midnight backdrop
          uGradientSize: { value: 0.7 },
          uGradientCount: { value: 8.0 },
          uColor1Weight: { value: 1.0 },
          uColor2Weight: { value: 1.0 }
        };
      }

      init() {
        const viewSize = this.sceneManager.getViewSize();
        const geometry = new THREE.PlaneGeometry(viewSize.width, viewSize.height, 1, 1);

        const material = new THREE.ShaderMaterial({
          uniforms: this.uniforms,
          vertexShader: `
            varying vec2 vUv;
            void main() {
              gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
              vUv = uv;
            }
          `,
          fragmentShader: `
            uniform float uTime;
            uniform vec2 uResolution;
            uniform vec3 uColor1; uniform vec3 uColor2; uniform vec3 uColor3;
            uniform vec3 uColor4; uniform vec3 uColor5; uniform vec3 uColor6;
            uniform float uSpeed;
            uniform float uIntensity;
            uniform sampler2D uTouchTexture;
            uniform float uGrainIntensity;
            uniform vec3 uDarkNavy;
            uniform float uGradientSize;
            uniform float uGradientCount;
            uniform float uColor1Weight;
            uniform float uColor2Weight;
            
            varying vec2 vUv;
            
            float grain(vec2 uv, float time) {
              vec2 grainUv = uv * uResolution * 0.5;
              return fract(sin(dot(grainUv + time, vec2(12.9898, 78.233))) * 43758.5453) * 2.0 - 1.0;
            }
            
            vec3 getGradientColor(vec2 uv, float time) {
              float gradientRadius = uGradientSize;
              
              vec2 center1 = vec2(0.5 + sin(time * uSpeed * 0.4) * 0.4, 0.5 + cos(time * uSpeed * 0.5) * 0.4);
              vec2 center2 = vec2(0.5 + cos(time * uSpeed * 0.6) * 0.5, 0.5 + sin(time * uSpeed * 0.45) * 0.5);
              vec2 center3 = vec2(0.5 + sin(time * uSpeed * 0.35) * 0.45, 0.5 + cos(time * uSpeed * 0.55) * 0.45);
              vec2 center4 = vec2(0.5 + cos(time * uSpeed * 0.5) * 0.4, 0.5 + sin(time * uSpeed * 0.4) * 0.4);
              vec2 center5 = vec2(0.5 + sin(time * uSpeed * 0.7) * 0.35, 0.5 + cos(time * uSpeed * 0.6) * 0.35);
              vec2 center6 = vec2(0.5 + cos(time * uSpeed * 0.45) * 0.5, 0.5 + sin(time * uSpeed * 0.65) * 0.5);
              
              float dist1 = length(uv - center1); float dist2 = length(uv - center2);
              float dist3 = length(uv - center3); float dist4 = length(uv - center4);
              float dist5 = length(uv - center5); float dist6 = length(uv - center6);
              
              float influence1 = 1.0 - smoothstep(0.0, gradientRadius, dist1);
              float influence2 = 1.0 - smoothstep(0.0, gradientRadius, dist2);
              float influence3 = 1.0 - smoothstep(0.0, gradientRadius, dist3);
              float influence4 = 1.0 - smoothstep(0.0, gradientRadius, dist4);
              float influence5 = 1.0 - smoothstep(0.0, gradientRadius, dist5);
              float influence6 = 1.0 - smoothstep(0.0, gradientRadius, dist6);
              
              vec3 color = vec3(0.0);
              color += uColor1 * influence1 * (0.55 + 0.45 * sin(time * uSpeed)) * uColor1Weight;
              color += uColor2 * influence2 * (0.55 + 0.45 * cos(time * uSpeed * 1.2)) * uColor2Weight;
              color += uColor3 * influence3 * (0.55 + 0.45 * sin(time * uSpeed * 0.8)) * uColor1Weight;
              color += uColor4 * influence4 * (0.55 + 0.45 * cos(time * uSpeed * 1.3)) * uColor2Weight;
              color += uColor5 * influence5 * (0.55 + 0.45 * sin(time * uSpeed * 1.1)) * uColor1Weight;
              color += uColor6 * influence6 * (0.55 + 0.45 * cos(time * uSpeed * 0.9)) * uColor2Weight;
              
              color = clamp(color, vec3(0.0), vec3(1.0)) * uIntensity;
              float brightness = length(color);
              float mixFactor = max(brightness, 0.3);
              color = mix(uDarkNavy, color, mixFactor);
              
              return color;
            }
            
            void main() {
              vec2 uv = vUv;
              
              // Touch Distortion
              vec4 touchTex = texture2D(uTouchTexture, uv);
              float vx = -(touchTex.r * 2.0 - 1.0);
              float vy = -(touchTex.g * 2.0 - 1.0);
              float intensity = touchTex.b;
              
              uv.x += vx * 0.4 * intensity; 
              uv.y += vy * 0.4 * intensity;
              
              float dist = length(uv - 0.5);
              float ripple = sin(dist * 20.0 - uTime * 2.0) * 0.02 * intensity;
              uv += vec2(ripple);
              
              vec3 color = getGradientColor(uv, uTime);
              color += grain(uv, uTime) * uGrainIntensity;
              
              gl_FragColor = vec4(color, 1.0);
            }
          `
        });

        this.mesh = new THREE.Mesh(geometry, material);
        this.sceneManager.scene.add(this.mesh);
      }

      update(delta) {
        if (this.uniforms.uTime) this.uniforms.uTime.value += delta;
      }

      onResize(width, height) {
        const viewSize = this.sceneManager.getViewSize();
        if (this.mesh) {
          this.mesh.geometry.dispose();
          this.mesh.geometry = new THREE.PlaneGeometry(viewSize.width, viewSize.height, 1, 1);
        }
        if (this.uniforms.uResolution) this.uniforms.uResolution.value.set(width, height);
      }
    }

    class App {
      constructor() {
        this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        // MOBILE OPTIMIZATION: Limit pixel ratio to 1 on small devices to save battery/performance
        const pixelRatio = window.innerWidth < 768 ? 1 : Math.min(window.devicePixelRatio, 2);
        this.renderer.setPixelRatio(pixelRatio);
        
        document.getElementById("webGLApp").appendChild(this.renderer.domElement);

        this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        this.camera.position.z = 50;
        
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x06070e); 
        
        this.clock = new THREE.Clock();
        this.touchTexture = new TouchTexture();
        this.gradientBackground = new GradientBackground(this);
        this.gradientBackground.uniforms.uTouchTexture.value = this.touchTexture.texture;

        this.init();
      }

      init() {
        this.gradientBackground.init();
        this.tick();
        
        window.addEventListener("resize", () => this.onResize());
        window.addEventListener("mousemove", (ev) => this.onMouseMove(ev));
        window.addEventListener("touchmove", (ev) => this.onTouchMove(ev), { passive: true });
      }

      onTouchMove(ev) {
        const touch = ev.touches[0];
        this.onMouseMove({ clientX: touch.clientX, clientY: touch.clientY });
      }

      onMouseMove(ev) {
        this.mouse = {
          x: ev.clientX / window.innerWidth,
          y: 1 - (ev.clientY / window.innerHeight)
        };
        this.touchTexture.addTouch(this.mouse);
      }

      getViewSize() {
        const fovInRadians = (this.camera.fov * Math.PI) / 180;
        const height = Math.abs(this.camera.position.z * Math.tan(fovInRadians / 2) * 2);
        return { width: height * this.camera.aspect, height };
      }

      tick() {
        const delta = Math.min(this.clock.getDelta(), 0.1);
        this.touchTexture.update();
        this.gradientBackground.update(delta);
        this.renderer.render(this.scene, this.camera);
        requestAnimationFrame(() => this.tick());
      }

      onResize() {
        this.camera.aspect = window.innerWidth / window.innerHeight;
        this.camera.updateProjectionMatrix();
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        
        // Re-evaluate pixel ratio on resize/orientation change
        const pixelRatio = window.innerWidth < 768 ? 1 : Math.min(window.devicePixelRatio, 2);
        this.renderer.setPixelRatio(pixelRatio);
        
        this.gradientBackground.onResize(window.innerWidth, window.innerHeight);
      }
    }
    const webGLApp = new App();


    // ==========================================
    // 2. CUSTOM CURSOR (Disabled on Touch)
    // ==========================================
    const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
    
    if (!isTouchDevice) {
      const cursor = document.getElementById("customCursor");
      let mouseX = window.innerWidth / 2;
      let mouseY = window.innerHeight / 2;

      document.addEventListener("mousemove", (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        cursor.style.left = mouseX + "px";
        cursor.style.top = mouseY + "px";
      });

      document.querySelectorAll("a, button").forEach(el => {
        el.addEventListener("mouseenter", () => {
          cursor.style.width = "60px";
          cursor.style.height = "60px";
          cursor.style.borderColor = "rgba(255, 255, 255, 0.1)";
          cursor.style.background = "rgba(255, 255, 255, 0.1)";
        });
        el.addEventListener("mouseleave", () => {
          cursor.style.width = "40px";
          cursor.style.height = "40px";
          cursor.style.borderColor = "var(--text-muted)";
          cursor.style.background = "transparent";
        });
      });
    }


    // ==========================================
    // 3. SMOOTH SCROLL & GSAP ANIMATIONS
    // ==========================================
    gsap.registerPlugin(ScrollTrigger);

    const lenis = new Lenis({
      duration: 1.2,
      easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
      direction: 'vertical',
      gestureDirection: 'vertical',
      smooth: true,
      smoothTouch: false, // Ensures native smooth touch scrolling on mobile
    });

    function raf(time) {
      lenis.raf(time);
      requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    lenis.on('scroll', ScrollTrigger.update);
    gsap.ticker.add((time)=>{ lenis.raf(time * 1000); });
    gsap.ticker.lagSmoothing(0, 0);

    // Initial Hero Animation
    const tlLoader = gsap.timeline();
    tlLoader.from('.hero-content .line', {
      yPercent: 120,
      opacity: 0,
      stagger: 0.15,
      duration: 1.5,
      ease: 'expo.out',
      delay: 0.2
    })
    .from('.nav-fade', {
      y: 20,
      opacity: 0,
      stagger: 0.2,
      duration: 1.2,
      ease: 'power3.out'
    }, "-=1");

    // Scroll Animations
    gsap.utils.toArray('.gs-reveal').forEach(elem => {
      gsap.from(elem, {
        scrollTrigger: {
          trigger: elem,
          start: "top 85%",
        },
        y: 60,
        opacity: 0,
        duration: 1.2,
        ease: "power3.out"
      });
    });

    gsap.utils.toArray('.gs-reveal-up').forEach(elem => {
      gsap.from(elem, {
        scrollTrigger: {
          trigger: elem,
          start: "top 80%",
        },
        scale: 0.95,
        y: 80,
        opacity: 0,
        duration: 1.5,
        ease: "expo.out"
      });
    });

    // Palette shift for dress code section
    const bgUniforms = webGLApp.gradientBackground.uniforms;
    gsap.timeline({
      scrollTrigger: {
        trigger: ".dress-code-section",
        start: "top 78%",
        end: "bottom 35%",
        scrub: true,
      }
    })
    .to(bgUniforms.uColor1.value, { x: 0.52, y: 0.66, z: 0.49, ease: "none" }, 0)
    .to(bgUniforms.uColor2.value, { x: 0.35, y: 0.48, z: 0.30, ease: "none" }, 0)
    .to(bgUniforms.uColor3.value, { x: 0.78, y: 0.56, z: 0.60, ease: "none" }, 0)
    .to(bgUniforms.uColor4.value, { x: 0.40, y: 0.62, z: 0.54, ease: "none" }, 0)
    .to(bgUniforms.uColor5.value, { x: 0.83, y: 0.74, z: 0.58, ease: "none" }, 0)
    .to(bgUniforms.uColor6.value, { x: 0.67, y: 0.51, z: 0.55, ease: "none" }, 0)
    .to(bgUniforms.uDarkNavy.value, { x: 0.07, y: 0.12, z: 0.09, ease: "none" }, 0)
    .to(bgUniforms.uIntensity, { value: 1.28, ease: "none" }, 0)
    .to(bgUniforms.uGrainIntensity, { value: 0.035, ease: "none" }, 0)
    .to(bgUniforms.uSpeed, { value: 0.68, ease: "none" }, 0);

    // RSVP modal controls
    const rsvpModal = document.getElementById("rsvpModal");
    const openRsvpBtn = document.getElementById("openRsvpBtn");
    const closeRsvpBtn = document.getElementById("closeRsvpBtn");
    const rsvpBackdrop = document.getElementById("rsvpBackdrop");

    function openRsvpModal() {
      rsvpModal.classList.add("open");
      rsvpModal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";
    }

    function closeRsvpModal() {
      rsvpModal.classList.remove("open");
      rsvpModal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
    }

    openRsvpBtn.addEventListener("click", openRsvpModal);
    closeRsvpBtn.addEventListener("click", closeRsvpModal);
    rsvpBackdrop.addEventListener("click", closeRsvpModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && rsvpModal.classList.contains("open")) closeRsvpModal();
    });

    // Minimal countdown (to April 4, 2026)
    const countdownEl = document.getElementById("countdownMinimal");
    const weddingDate = new Date("2026-04-04T16:30:00");
    function updateCountdown() {
      const now = new Date();
      const ms = weddingDate - now;
      if (ms <= 0) {
        countdownEl.textContent = "Today";
        return;
      }
      const totalSeconds = Math.floor(ms / 1000);
      const days = Math.floor(totalSeconds / 86400);
      const hours = Math.floor((totalSeconds % 86400) / 3600);
      const mins = Math.floor((totalSeconds % 3600) / 60);
      countdownEl.textContent = `${days}d ${hours}h ${mins}m`;
    }
    updateCountdown();
    setInterval(updateCountdown, 1000);

  </script>
</body>
</html>
